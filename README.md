# Система управления новостями

## Микросервис micro-news, работающий непосредственно с новостями

Является частью общей системы
- [ News Management System](https://github.com/rusakovich-viktar/news-management-system/tree/develop)

### Основные сущности и назначение:

- news (новость) содержит поля: id, time, title, text и comments (list).
- CRUD для работы с новостью
- просмотр списка новостей (с пагинацией)
- просмотр новости с комментариями относящимися к ней (с пагинацией)

### Стек технологий, примененный в micro-news

	Использованы Spring Boot 3.2.3, Java 17, Gradle 8.5 и PostgreSQL 15.1; 
    Spring Data JPA, Hibernate validator, Spring Web, liquibase, mapstruct, redis, spring-cloud-openFeign, spring-cloud-config-client, lombok
    Для тестирования использованы spring-boot-testcontainers, junit5, Mockito, Wiremock

### Реализация. Общие пояснения к деталям

Микросервис получает конфиги из micro-config-server-cloud сервиса, поэтому необходимо чтобы сервер с конфигами при
старте данного микросервиса работал.

### Используется одна база данных, к каждой таблице которой обращается свой микросервис

![структура](https://github.com/rusakovich-viktar/NMS-resourses/raw/rusakovich-viktar-patch-1/Снимок%20экрана%202024-03-04%20151246.jpg)

### Реализованы и подключены два Spring Boot Starter:

```
- logger-aspect-starter реализует логирование запрос-ответ в аспектном стиле (для слоя Controlles)
- exception-handler-starter реализует глобальную обработку исключений и интерпретацию их согласно REST.
Стартеры при сборке загружаются первыми, далее из локального репозитория .m2 как зависимости подключаются к другим микросервисам.
```

### Подключен Liquibase — система управления миграциями базы данных. Дабы не дублировать код база накатывается сразу для сервиса новостей и для сервиса комментариев:

```
- При запуске сервиса news накатываются скрипты на рабочую БД (генерируются необходимые таблицы из одного файла и наполняются таблицы данными из другого файла, 20 новостей и 10 комментариев, связанных с каждой новостью.
при запуске тестов подхватывается скрипт по генерации необходимых таблиц + дополнительно из sql файлов заполняются таблицы во время тестирования.
Реализовано - через разные changelog и контексты Liquibase. Для тестов подхватывается еще скрипт наполнения таблиц.
``` 

### Создана и подключена реализация кэша, для хранения сущностей:

```
Самописный кеш реализован согласно заданию через Proxy с использованием AOP. Подключен для микросервисов новостей и комментариев в @Profile dev.
```

### Подключен кэш провайдер Redis (в docker):

```bash
Подключен для микросервисов новостей и комментариев в @Profile prod.
```

### Документация swagger доступна по пути `/api`

```
Код документирован @JavaDoc, подключен Swagger (OpenAPI 3.0)
```

### Тестирование. Сервисный слой покрыт на 100%, весь код 85-90%.

![news-coverage](https://github.com/rusakovich-viktar/NMS-resourses/raw/rusakovich-viktar-patch-1/news-coverage.jpg)

	Весь код покрыт юнит-тестами от 80% (сервисный слой – 100%)
    Использованы testcontainers в тестах на persistence layer (для БД)
 	Написаны интеграционные тесты
    Использован WireMock в тестах для слоя clients (разбиение на микросервисы)

    Все порты 8081 и 8082 должны быть свободны, чтобы не мешать поднятию контекста.    
    Также для тестирования база данных поднималась локально. Тестирование проводится в @Profile dev.

### Использован Docker, написан DockerFile

```
Написаны Dockerfile – для каждого spring boot приложения, создан общий docker-compose.yml для поднятия всех сервисов в контейнерах, настроено взаимодействие между ними)
```
### Реализована поддержка @Profile prod и dev. Конфиги вынесены в Spring Cloud Config:
```
- В контексте приложения условно будем считать что профиль prod будет применяться для запуска и взаимодействия микосервисов в docker сети.
Для локальной разработки, а также для тестирования будем использовать профиль dev.
- Профили конфигурируются через micro-config-server-cloud, поэтому он должен быть запущен или в контейнере для профиля prod или локально для профиля dev.
- Для смены профиля dev(локально и тесты) и prod(в докере) необходимо в папка проекта в application.yml сменить активный профиль на 
profiles: active: dev 
или 
profiles: active: prod
```
# Как запустить приложение

Является частью сервиса по управлению новостями, желательно запускать совместно с прочими микросервисами по инструкции
из [News Management System](https://github.com/rusakovich-viktar/news-management-system/tree/develop)

- Можно запустить одиночно локально, будут работать операции create-read-update
- Порт для запуска 8081

Можно обращаться напрямую по http://localhost:8081/news, но так как реализован доступ к сервису через gateway, после
полного запуска всех микросервисов можно выполнять все те же операции через gateway http://localhost:8080/news/*

## ЭНДПОИНТЫ И ИНТЕРФЕЙС

Все эндпоинты выполнены с учетом требований REST, Документация swagger доступна по пути `/api`

<details>
 <summary><strong>
 подробнее - раскрывающийся список эндпоинтов
</strong></summary>

#### 1. POST запрос на http://localhost:8081/news с телом

```
{
"title": "news title",
"text": "news text"
} 
```

создает новость и возвращает ответ типа, добавляя текущее время создания и обновления новости, а также id новости из бд.

```
{
    "id": 21,
    "time": "2024-03-07T00:49:17.6342883",
    "updateTime": "2024-03-07T00:49:17.6342883",
    "title": "news title",
    "text": "news text"
} 
```

#### 2. GET запрос на http://localhost:8081/news/{newsId}, где newsId = 10 даст ответ

```
{
    "id": 10,
    "time": "2024-02-29T17:34:51.156603",
    "updateTime": "2024-02-29T17:34:51.156603",
    "title": "Дизайнеры придумали безумную ванну, похожую на гамак. Рассказываем, как это работает",
    "text": "Фантазия дизайнеров не знает границ...."
}
```
#### 3. GET запрос на http://localhost:8081/news, вернет список новостей, по умолчанию 20 на странице
- можно настроить пагинацию, например, добавив к запросу `?page=0&size=2`, где page номер страницы с 0, а size количество отображаемых новостей на странице  
- получим ответ типа: 
```
{
    "content": [
        {
            "id": 1,
            "time": "2024-02-15T10:10:11.223344",
            "updateTime": "2024-02-15T10:10:11.223344",
            "title": "OpenAI может разрабатывать поисковик с возможностями искусственного интеллекта",
            "text": "Согласно источника..."
        },
        {
            "id": 2,
            "time": "2024-02-16T12:12:12.112233",
            "updateTime": "2024-02-16T12:12:12.112233",
            "title": "Тинькофф-банк обновил логотип",
            "text": "Тинькофф-банк обновил лога..."
        }
    ],
    "pageable": {
        "pageNumber": 0,
        "pageSize": 2,
        "sort": [],
        "offset": 0,
        "paged": true,
        "unpaged": false
    },
    "totalElements": 121,
    "totalPages": 61,
    "last": false,
    "size": 2,
    "number": 0,
    "sort": [],
    "first": true,
    "numberOfElements": 2,
    "empty": false
}
```
#### 4. PUT запрос на http://localhost:8081/news/{newsId}, где newsId = 10 с телом 

```
{
    "title": "Обновленный заголовок",
    "text": "Обновленный текст новости"
}
```

обновит поля новости с id = 10 и возвращает ответ типа, обновляя данные поля, а также поле updateTime, устанавливая текущее время.

```
{
    "id": 10,
    "time": "2024-02-29T17:34:51.156603",
    "updateTime": "2024-03-07T01:03:28.951786",
    "title": "Обновленный заголовок",
    "text": "Обновленный текст новости"
}
```
#### 5. При **работающем сервисе комментариев** DELETE запрос на http://localhost:8081/news/{newsId}, где newsId = 10 даст ответ без тела, со статусом 201 No Content
- повторный запрос на этот же адрес будет возвращать один и тот же ответ, так как запрос **идемпотентный**, что и требуется по REST, 
```
{
    "timestamp": "2024-03-07T01:06:44.5352849",
    "status": 404,
    "error": "Not Found",
    "message": "News with id 10 does not exist"
}
```

#### 6. При работающем сервисе комментариев GET запрос на http://localhost:8081/news/{newsId}/comments, вернет список комментариев, связанных с новостью {newsId}, по умолчанию 20 на странице
- можно настроить пагинацию, например, добавив к запросу `?page=0&size=2`, где page номер страницы с 0, а size количество отображаемых новостей на странице
- для запроса http://localhost:8081/news/11/comments?page=0&size=2 получим ответ типа:
```
{
    "comments": [
        {
            "id": 101,
            "time": "2024-02-29T17:34:51.185191",
            "updateTime": "2024-02-29T17:34:51.185191",
            "text": "отличная новость",
            "username": "user1",
            "newsId": 11
        },
        {
            "id": 102,
            "time": "2024-02-29T17:34:51.185191",
            "updateTime": "2024-02-29T17:34:51.185191",
            "text": "информация на высоте",
            "username": "user2",
            "newsId": 11
        }
    ]
}
```
</details>